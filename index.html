<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imagine Engine 用户体验调研</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* 核心主色调 - 提取自项目文档风格 */
            --primary-color: #0F2C59; /* 深邃蓝 */
            --accent-color: #4472C4;  /* 活力蓝 (文档表格表头色) */
            --text-main: #1A202C;
            --text-secondary: #4A5568;
            --bg-body: #F8F9FB;
            --bg-card: #FFFFFF;
            --border-color: #E2E8F0;
            --success-color: #38A169;
            
            /* 阴影 - 柔和高级感 */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* 顶部装饰条 */
        .top-bar {
            height: 6px;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 100;
        }

        .container {
            max-width: 800px;
            margin: 60px auto;
            padding: 0 20px;
        }

        /* 头部区域 */
        header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeIn 0.8s ease-out;
        }

        .logo-text {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            letter-spacing: -0.5px;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* 卡片通用样式 */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            padding: 32px;
            margin-bottom: 24px;
            border: 1px solid rgba(0,0,0,0.02);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--bg-body);
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            display: block;
            width: 4px;
            height: 20px;
            background-color: var(--accent-color);
            margin-right: 12px;
            border-radius: 2px;
        }

        /* 表单元素样式 */
        .form-group {
            margin-bottom: 24px;
        }

        .label {
            display: block;
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--text-main);
        }

        .label .required {
            color: #E53E3E;
            margin-left: 4px;
        }

        /* 单选和多选按钮优化 */
        .radio-group, .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .custom-control {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .custom-control:hover {
            background-color: #F7FAFC;
            border-color: #CBD5E0;
        }

        .custom-control input {
            margin-right: 12px;
            accent-color: var(--accent-color);
            width: 18px;
            height: 18px;
        }

        /* 评分组件 */
        .rating-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #F8F9FB;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .rating-label {
            font-weight: 500;
            color: var(--text-secondary);
            flex: 1;
        }

        .rating-stars {
            display: flex;
            gap: 8px;
            flex-direction: row-reverse; /* 为了CSS hover效果 */
            justify-content: flex-end;
        }

        .rating-stars input {
            display: none;
        }

        .rating-stars label {
            cursor: pointer;
            width: 30px;
            height: 30px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23CBD5E0'%3E%3Cpath d='M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            transition: transform 0.2s;
        }

        .rating-stars input:checked ~ label,
        .rating-stars label:hover,
        .rating-stars label:hover ~ label {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23F6AD55'%3E%3Cpath d='M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z'/%3E%3C/svg%3E");
            transform: scale(1.1);
        }

        /* 文本域 */
        textarea {
            width: 100%;
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            resize: vertical;
            min-height: 120px;
            transition: border-color 0.2s;
            background-color: #FAFAFA;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(68, 114, 196, 0.1);
        }

        textarea::placeholder {
            color: #A0AEC0;
        }

        /* 提交按钮 */
        .submit-btn {
            display: block;
            width: 100%;
            padding: 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(15, 44, 89, 0.2);
            margin-top: 40px;
        }

        .submit-btn:hover {
            background-color: #0A1F40; /* 更深的蓝 */
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(15, 44, 89, 0.3);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        /* 动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in-up {
            animation: fadeIn 0.6s ease-out forwards;
            opacity: 0;
        }
        
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }
        .delay-300 { animation-delay: 0.3s; }

        /* 响应式调整 */
        @media (max-width: 600px) {
            .container {
                margin-top: 40px;
                padding: 0 16px;
            }
            .card {
                padding: 24px 20px;
            }
            .logo-text {
                font-size: 2rem;
            }
        }

        /* 加载状态 */
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .submit-btn.loading {
            position: relative;
            color: transparent;
        }

        .submit-btn.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 提示消息 */
        .message {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            animation: slideDown 0.3s ease-out;
            max-width: 500px;
            width: 90%;
        }

        .message.success {
            background-color: var(--success-color);
            color: white;
        }

        .message.error {
            background-color: #E53E3E;
            color: white;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .message.hide {
            animation: slideUp 0.3s ease-out forwards;
        }

        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
        }
    </style>
</head>
<body>

    <div class="top-bar"></div>

    <div class="container">
        <header>
            <div class="logo-text">Imagine Engine</div>
            <p class="subtitle">智能图像创作与科研绘图辅助平台 · 用户体验调研</p>
            <p style="margin-top:12px; font-size: 0.9rem; color: #718096; max-width: 600px; margin-left: auto; margin-right: auto;">
                感谢您成为我们的首批用户。您的反馈对我们至关重要，将帮助我们优化科研绘图质量、修复系统问题，为您提供更精准的辅助工具。
            </p>
        </header>

        <!-- 提示消息容器 -->
        <div id="messageContainer"></div>

        <form id="surveyForm">
            
            <!-- 第一部分：基本信息 -->
            <div class="card fade-in-up">
                <div class="section-title">01. 基本信息</div>
                
                <div class="form-group">
                    <label class="label">您的主要身份是 <span class="required">*</span></label>
                    <div class="radio-group">
                        <label class="custom-control">
                            <input type="radio" name="role" value="student">
                            <span>高校学生（科研绘图/论文配图）</span>
                        </label>
                        <label class="custom-control">
                            <input type="radio" name="role" value="researcher">
                            <span>科研工作者/教师</span>
                        </label>
                        <label class="custom-control">
                            <input type="radio" name="role" value="media">
                            <span>自媒体/电商从业者</span>
                        </label>
                        <label class="custom-control">
                            <input type="radio" name="role" value="other">
                            <span>其他</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- 第二部分：使用问题反馈 -->
            <div class="card fade-in-up delay-100">
                <div class="section-title">02. 核心体验反馈</div>
                <p style="margin-bottom: 20px; color: #718096; font-size: 0.9rem;">
                    请根据您在 2025年11月-12月 期间的使用体验回答。
                </p>

                <div class="form-group">
                    <label class="label">您在使用过程中遇到过哪些问题？（多选）<span class="required">*</span></label>
                    <div class="checkbox-group">
                        <label class="custom-control">
                            <input type="checkbox" name="issues" value="quota_display">
                            <span>配额显示异常（如显示 0/0 但有订阅）</span>
                        </label>
                        <label class="custom-control">
                            <input type="checkbox" name="issues" value="text_recognition">
                            <span>科研绘图文字生成不准确（文字乱码/非真实文字）</span>
                        </label>
                        <label class="custom-control">
                            <input type="checkbox" name="issues" value="error_msg">
                            <span>错误提示看不懂（如显示英文代码 QUOTA_EXHAUSTED）</span>
                        </label>
                        <label class="custom-control">
                            <input type="checkbox" name="issues" value="dashboard_info">
                            <span>仪表盘信息不完整（看不到套餐到期时间等）</span>
                        </label>
                        <label class="custom-control">
                            <input type="checkbox" name="issues" value="image_style">
                            <span>图片风格过于花哨，不适合科研严谨性</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- 第三部分：功能评分 -->
            <div class="card fade-in-up delay-200">
                <div class="section-title">03. 功能满意度评分</div>
                
                <!-- 易用性 -->
                <div class="rating-container">
                    <span class="rating-label">操作易用性</span>
                    <div class="rating-stars">
                        <input type="radio" name="usability" id="u5" value="5"><label for="u5"></label>
                        <input type="radio" name="usability" id="u4" value="4"><label for="u4"></label>
                        <input type="radio" name="usability" id="u3" value="3"><label for="u3"></label>
                        <input type="radio" name="usability" id="u2" value="2"><label for="u2"></label>
                        <input type="radio" name="usability" id="u1" value="1"><label for="u1"></label>
                    </div>
                </div>

                <!-- 错误处理 -->
                <div class="rating-container">
                    <span class="rating-label">错误提示清晰度</span>
                    <div class="rating-stars">
                        <input type="radio" name="error_handling" id="e5" value="5"><label for="e5"></label>
                        <input type="radio" name="error_handling" id="e4" value="4"><label for="e4"></label>
                        <input type="radio" name="error_handling" id="e3" value="3"><label for="e3"></label>
                        <input type="radio" name="error_handling" id="e2" value="2"><label for="e2"></label>
                        <input type="radio" name="error_handling" id="e1" value="1"><label for="e1"></label>
                    </div>
                </div>

                <!-- 仪表盘 -->
                <div class="rating-container">
                    <span class="rating-label">仪表盘信息完整度</span>
                    <div class="rating-stars">
                        <input type="radio" name="dashboard" id="d5" value="5"><label for="d5"></label>
                        <input type="radio" name="dashboard" id="d4" value="4"><label for="d4"></label>
                        <input type="radio" name="dashboard" id="d3" value="3"><label for="d3"></label>
                        <input type="radio" name="dashboard" id="d2" value="2"><label for="d2"></label>
                        <input type="radio" name="dashboard" id="d1" value="1"><label for="d1"></label>
                    </div>
                </div>

                <!-- 科研绘图 -->
                <div class="rating-container">
                    <span class="rating-label">科研绘图生成质量</span>
                    <div class="rating-stars">
                        <input type="radio" name="quality" id="q5" value="5"><label for="q5"></label>
                        <input type="radio" name="quality" id="q4" value="4"><label for="q4"></label>
                        <input type="radio" name="quality" id="q3" value="3"><label for="q3"></label>
                        <input type="radio" name="quality" id="q2" value="2"><label for="q2"></label>
                        <input type="radio" name="quality" id="q1" value="1"><label for="q1"></label>
                    </div>
                </div>
            </div>

            <!-- 第四部分：开放反馈 -->
            <div class="card fade-in-up delay-300">
                <div class="section-title">04. 建议与展望</div>

                <div class="form-group">
                    <label class="label">您目前最不满意的功能是什么？为什么？</label>
                    <textarea name="dissatisfaction" placeholder="例如：文字识别不准确导致我需要花费额外时间修图..."></textarea>
                </div>

                <div class="form-group">
                    <label class="label">如果有机会，您最希望我们在下一个版本中添加什么功能？</label>
                    <textarea name="suggestion" placeholder="例如：支持批量导出、支持更多生物医学模板..."></textarea>
                </div>

                <div class="form-group" style="margin-top: 30px; border-top: 1px dashed var(--border-color); padding-top: 20px;">
                    <label class="label">总体评价 (1-5分) <span class="required">*</span></label>
                    <div style="display: flex; gap: 20px; align-items: center;">
                        <div class="rating-stars" style="flex-direction: row-reverse; width: fit-content;">
                            <input type="radio" name="overall" id="o5" value="5"><label for="o5"></label>
                            <input type="radio" name="overall" id="o4" value="4"><label for="o4"></label>
                            <input type="radio" name="overall" id="o3" value="3"><label for="o3"></label>
                            <input type="radio" name="overall" id="o2" value="2"><label for="o2"></label>
                            <input type="radio" name="overall" id="o1" value="1"><label for="o1"></label>
                        </div>
                        <span style="color: #718096; font-size: 0.9rem;">(5分为非常满意)</span>
                    </div>
                </div>
            </div>

            <button type="submit" class="submit-btn fade-in-up delay-300">提交反馈</button>
            
            <p style="text-align: center; margin-top: 24px; color: #A0AEC0; font-size: 0.85rem;">
                © 2025 Imagine Engine Team. All Rights Reserved.
            </p>
        </form>
    </div>

    <!-- Supabase JS 客户端库 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    
    <script>
        // Supabase 配置 - 使用 wenjuan 项目
        const SUPABASE_URL = 'https://plsibdmbgfnnlkmggkxk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBsc2liZG1iZ2ZubmxrbWdna3hrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNzEyOTMsImV4cCI6MjA3Njk0NzI5M30.ic0LNhWSYPRxRZJrs8CTcu0KZvg8Npy4zmj-HMD9jSo';
        
        // 初始化 Supabase 客户端 - 完全匿名模式，不进行任何认证检查
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: false,
                autoRefreshToken: false,
                detectSessionInUrl: false
            },
            global: {
                headers: {
                    'apikey': SUPABASE_ANON_KEY
                }
            }
        });

        // 显示提示消息
        function showMessage(text, type = 'success') {
            const container = document.getElementById('messageContainer');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            container.appendChild(message);

            // 3秒后自动隐藏
            setTimeout(() => {
                message.classList.add('hide');
                setTimeout(() => message.remove(), 300);
            }, 3000);
        }

        // 获取当前用户（如果已登录）
        // 注意：对于匿名提交，我们直接返回 null，不尝试获取用户信息
        // 这样可以避免 403 错误
        async function getCurrentUser() {
            // 直接返回 null，以匿名方式提交
            // 不调用 supabase.auth.getUser() 避免 403 错误
            console.log('匿名用户，将以匿名方式提交');
            return null;
        }

        // 获取 IP 地址（简化版，实际应该通过后端获取）
        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return null;
            }
        }

        // 表单验证
        function validateForm(formData) {
            const errors = [];

            // 验证必填项
            if (!formData.role) {
                errors.push('请选择您的主要身份');
            }

            if (!formData.issues || formData.issues.length === 0) {
                errors.push('请至少选择一项遇到的问题');
            }

            if (!formData.overall_rating) {
                errors.push('请给出总体评价');
            }

            return errors;
        }

        // 收集表单数据
        function collectFormData() {
            const form = document.getElementById('surveyForm');
            const formData = new FormData(form);

            // 基本信息
            const role = formData.get('role');

            // 问题反馈（多选）
            const issues = formData.getAll('issues');

            // 评分
            const usability = formData.get('usability');
            const error_handling = formData.get('error_handling');
            const dashboard = formData.get('dashboard');
            const quality = formData.get('quality');
            const overall = formData.get('overall');

            // 开放反馈
            const dissatisfaction = formData.get('dissatisfaction')?.trim() || null;
            const suggestion = formData.get('suggestion')?.trim() || null;

            return {
                role,
                issues,
                usability_rating: usability ? parseInt(usability) : null,
                error_handling_rating: error_handling ? parseInt(error_handling) : null,
                dashboard_rating: dashboard ? parseInt(dashboard) : null,
                quality_rating: quality ? parseInt(quality) : null,
                overall_rating: overall ? parseInt(overall) : null,
                dissatisfaction,
                suggestion
            };
        }

        // 提交表单
        async function handleSubmit(event) {
            event.preventDefault();

            const submitBtn = document.querySelector('.submit-btn');
            const originalText = submitBtn.textContent;

            // 禁用按钮并显示加载状态
            submitBtn.disabled = true;
            submitBtn.classList.add('loading');
            submitBtn.textContent = '提交中...';

            try {
                // 收集表单数据
                const formData = collectFormData();

                // 验证表单
                const errors = validateForm(formData);
                if (errors.length > 0) {
                    showMessage(errors[0], 'error');
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('loading');
                    submitBtn.textContent = originalText;
                    return;
                }

                // 获取用户ID（匿名用户直接返回 null，不调用 API）
                const userId = await getCurrentUser();

                // 获取 IP 地址和 User Agent
                const ipAddress = await getIPAddress();
                const userAgent = navigator.userAgent;

                // 准备提交数据 - 确保user_id可以为null（匿名用户）
                // 确保 issues 是数组格式，即使为空也要是空数组
                const surveyData = {
                    user_id: null,  // 匿名用户，明确设置为 null
                    role: formData.role,
                    issues: formData.issues && formData.issues.length > 0 ? formData.issues : [],  // 空数组而不是null
                    usability_rating: formData.usability_rating || null,
                    error_handling_rating: formData.error_handling_rating || null,
                    dashboard_rating: formData.dashboard_rating || null,
                    quality_rating: formData.quality_rating || null,
                    overall_rating: formData.overall_rating,  // 必填项
                    dissatisfaction: formData.dissatisfaction || null,
                    suggestion: formData.suggestion || null,
                    ip_address: ipAddress || null,
                    user_agent: userAgent || null
                };

                console.log('准备提交的数据:', JSON.stringify(surveyData, null, 2));
                console.log('Supabase URL:', SUPABASE_URL);
                console.log('匿名模式提交');

                // 提交到 Supabase - 使用匿名客户端，不进行任何认证
                console.log('开始提交到 Supabase...');
                const { data, error } = await supabase
                    .from('user_feedback_surveys')
                    .insert([surveyData])
                    .select();

                if (error) {
                    console.error('提交失败:', error);
                    console.error('完整错误对象:', JSON.stringify(error, null, 2));
                    console.error('错误详情:', {
                        message: error.message,
                        details: error.details,
                        hint: error.hint,
                        code: error.code
                    });
                    
                    // 更详细的错误提示
                    let errorMsg = '提交失败：';
                    if (error.message) {
                        if (error.message.includes('row-level security') || error.message.includes('RLS')) {
                            errorMsg += '权限验证失败。策略已配置为允许匿名用户，请刷新页面后重试。';
                        } else if (error.message.includes('violates')) {
                            errorMsg += '数据验证失败：' + error.message;
                        } else {
                            errorMsg += error.message;
                        }
                    } else {
                        errorMsg += '网络错误，请稍后重试';
                    }
                    
                    // 在控制台显示完整错误信息以便调试
                    console.error('错误信息:', errorMsg);
                    
                    showMessage(errorMsg, 'error');
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('loading');
                    submitBtn.textContent = originalText;
                } else {
                    // 提交成功
                    console.log('提交成功:', data);
                    showMessage('✅ 感谢您的反馈！您的意见对我们非常重要。', 'success');
                    
                    // 清空表单
                    form.reset();
                    
                    // 滚动到顶部
                    window.scrollTo({ top: 0, behavior: 'smooth' });

                    // 3秒后恢复按钮（虽然表单已清空）
                    setTimeout(() => {
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('loading');
                        submitBtn.textContent = originalText;
                    }, 3000);
                }
            } catch (error) {
                console.error('提交异常:', error);
                showMessage('提交失败：' + (error.message || '网络错误，请稍后重试'), 'error');
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');
                submitBtn.textContent = originalText;
            }
        }

        // 绑定表单提交事件
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('surveyForm');
            form.addEventListener('submit', handleSubmit);

            // 匿名用户模式，不检查登录状态
            console.log('问卷系统已加载，匿名用户模式');
        });
    </script>

</body>
</html>